<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <script>
      const moveToNextMonday = (date) => {
        const day = date.getDay();
        if (day === 6) {
          date.setDate(date.getDate() + 2);
        } else if (day === 0) {
          date.setDate(date.getDate() + 1);
        }
        return date;
      };

      const generateDeliverableClassTasks = (allTasks, initialDate) => {
        let previousObjectEndDate = new Date(initialDate);
        allTasks?.forEach((task) => {
          let taskMinStartDate = null;
          let taskMaxEndDate = null;
          let taskTotalDuration = 0;

          task?.subtasks.forEach((subtask) => {
            let subtaskMinStartDate = null;
            let subtaskMaxEndDate = null;
            let subtaskTotalDuration = 0;

            if (!subtask?.subtasks) return -1;

            subtask?.subtasks.forEach((tt) => {
              tt.StartDate = previousObjectEndDate; // .toDateString();
              tt.Duration = +tt.days;

              // Move to next Monday if the task starts on a weekend
              moveToNextMonday(previousObjectEndDate);

              let newEndDate = new Date(previousObjectEndDate);

              if (tt.days == "" || +tt.days == 1) {
                tt.EndDate = tt.StartDate;
              } else if (tt.days && +tt.days >= 2) {
                newEndDate.setDate(
                  previousObjectEndDate.getDate() + (+tt.days - 1)
                );

                // Move end date to next Monday if it falls on a weekend
                moveToNextMonday(newEndDate);

                tt.EndDate = newEndDate; // .toDateString();
              }

              if (
                !subtaskMinStartDate ||
                new Date(tt.StartDate) < new Date(subtaskMinStartDate)
              ) {
                subtaskMinStartDate = tt.StartDate;
              }
              if (
                !subtaskMaxEndDate ||
                new Date(tt.EndDate) > new Date(subtaskMaxEndDate)
              ) {
                subtaskMaxEndDate = tt.EndDate;
              }

              newEndDate.setDate(newEndDate.getDate() + 1);
              previousObjectEndDate = newEndDate;
              subtaskTotalDuration += tt.Duration;
            });

            subtask.StartDate = subtaskMinStartDate;
            subtask.EndDate = subtaskMaxEndDate;
            subtask.Duration = subtaskTotalDuration;

            if (
              !taskMinStartDate ||
              new Date(subtask.StartDate) < new Date(taskMinStartDate)
            ) {
              taskMinStartDate = subtask.StartDate;
            }
            if (
              !taskMaxEndDate ||
              new Date(subtask.EndDate) > new Date(taskMaxEndDate)
            ) {
              taskMaxEndDate = subtask.EndDate;
            }
            taskTotalDuration += subtaskTotalDuration;
          });

          task.StartDate = taskMinStartDate;
          task.EndDate = taskMaxEndDate;
          task.Duration = taskTotalDuration;
        });
        return allTasks;
      };

      const groupByDeliverableClassID = (arr) => {
        const result = arr.reduce((acc, curr) => {
          const deliverableClassID = curr.Deliverable_Class.ID;

          if (!acc[deliverableClassID]) {
            acc[deliverableClassID] = {
              Deliverable_Class: curr.Deliverable_Class,
              TaskID: curr.Deliverable_Class?.ID,
              TaskName: curr.Deliverable_Class?.display_value,
              StartDate: "",
              EndDate: "",
              subtasks: [],
            };
          }

          acc[deliverableClassID].subtasks.push(curr);

          return acc;
        }, {});
        return Object.values(result);
      };

      const revampSubtasks = (tasks) => {
        tasks.forEach((task) => {
          task.subtasks.forEach((subtask) => {
            subtask.TaskID = subtask?.ID;
            subtask.TaskName = subtask?.Name;
            subtask.StartDate = new Date("04/02/2019");
            subtask.EndDate = new Date("04/21/2019");
            subtask.subtasks = convertTasksArray(subtask?.Estimate_Tasks);
          });
        });
        return tasks;
      };

      const convertTasksArray = (displayValueArray) => {
        if (!displayValueArray?.length) return null;
        return displayValueArray.map((item) => {
          const [
            srNo,
            TaskName,
            taskType,
            description,
            mCost,
            lCost,
            TaskID,
            days,
            subConTotal,
            DC,
            total,
            estimateCommentsCount,
            estimateFileLogCounts,
            estimateMaterialsCount,
            estimateLaboursCount,
            estimateSubcontractorsCount,
          ] = item.display_value.split(";");
          return {
            srNo,
            TaskName,
            taskType,
            description,
            mCost,
            lCost,
            TaskID,
            days,
            subConTotal,
            DC,
            total,
            estimateCommentsCount,
            estimateFileLogCounts,
            estimateMaterialsCount,
            estimateLaboursCount,
            estimateSubcontractorsCount,
          };
        });
      };

      const generateTasks = (data, startDate) => {
        const classes = groupByDeliverableClassID(data);
        const subtasks = revampSubtasks(classes);
        const allTasks = generateDeliverableClassTasks(subtasks, startDate);
        return allTasks;
      };

      const data = [
        {
          "Add_Estimate_Worksheet.Estimate_No": "EST-0302",
          ATTENTION: "",
          "Add_Estimate_Worksheet.Auto_No": "302",
          Description:
            "<div>Project Supervision and Coordination during fabrication and Installation. <br /></div>",
          Rate: "8100.00",
          Apply_Tax_8_875: "false",
          Add_Estimate_Worksheet: {
            display_value: "1556703000046579063",
            ID: "1556703000046579063",
          },
          Final_Total: "",
          Sub_Total: "8100.00",
          S_No: "100",
          Unit: "Lumpsum",
          Name: "Project Management & Site Supervision",
          Qty: "1.00",
          Days: "2",
          Deliverable_Class: {
            display_value: "01 - General Requirements",
            ID: "1556703000040039707",
          },
          ID: "1556703000046579051",
          Estimate_Tasks: [
            {
              display_value:
                "100;Project Management;Project Management Team;Project Management;7600.00;200.00;1556703000046579068;1;200.00;01 - General Requirements;7600.00;0;3;1;0;1",
              ID: "1556703000046579068",
            },
            {
              display_value:
                "200;Site Superintendent;Site;Daily Site Supervision;0.00;300.00;1556703000046579070;1;300.00;01 - General Requirements;0.00;0;1;0;0;1",
              ID: "1556703000046579070",
            },
          ],
          Added_Time: "11-16-2023 13:00:06",
        },
        {
          "Add_Estimate_Worksheet.Estimate_No": "EST-0302",
          ATTENTION: "",
          "Add_Estimate_Worksheet.Auto_No": "302",
          Description:
            "<div>Mobilization and Delivery of Tools and Material to Site<br /></div>",
          Rate: "0.00",
          Apply_Tax_8_875: "false",
          Add_Estimate_Worksheet: {
            display_value: "1556703000046579063",
            ID: "1556703000046579063",
          },
          Final_Total: "",
          Sub_Total: "0.00",
          S_No: "200",
          Unit: "Lumpsum",
          Name: "Project Management & Site Supervision",
          Qty: "1.00",
          Days: "2",
          Deliverable_Class: {
            display_value: "01 - General Requirements",
            ID: "1556703000040039707",
          },
          ID: "1556703000046579055",
          Estimate_Tasks: [
            {
              display_value:
                "100;Project Management;Project Management Team;Project Management;0.00;0.00;1556703000046579072;1;0.00;01 - General Requirements;0.00;0;0;0;0;0",
              ID: "1556703000046579072",
            },
            {
              display_value:
                "200;Site Superintendent;Site;Daily Site Supervision;0.00;0.00;1556703000046579074;1;0.00;01 - General Requirements;0.00;0;0;0;0;0",
              ID: "1556703000046579074",
            },
          ],
          Added_Time: "11-16-2023 13:00:06",
        },
        {
          "Add_Estimate_Worksheet.Estimate_No": "EST-0302",
          ATTENTION: "",
          "Add_Estimate_Worksheet.Auto_No": "302",
          Description:
            "<div>Demobilization and Delivery of Tools and Material from Site to WH<br /></div>",
          Rate: "0.00",
          Apply_Tax_8_875: "false",
          Add_Estimate_Worksheet: {
            display_value: "1556703000046579063",
            ID: "1556703000046579063",
          },
          Final_Total: "",
          Sub_Total: "0.00",
          S_No: "300",
          Unit: "Lumpsum",
          Name: "Project Management & Site Supervision",
          Qty: "1.00",
          Days: "2",
          Deliverable_Class: {
            display_value: "01 - General Requirements",
            ID: "1556703000040039707",
          },
          ID: "1556703000046579059",
          Estimate_Tasks: [
            {
              display_value:
                "100;Project Management;Project Management Team;Project Management;0.00;0.00;1556703000046579076;3;0.00;01 - General Requirements;0.00;0;0;0;0;0",
              ID: "1556703000046579076",
            },
            {
              display_value:
                "200;Site Superintendent;Site;Daily Site Supervision;0.00;0.00;1556703000046579078;1;0.00;01 - General Requirements;0.00;0;0;0;0;0",
              ID: "1556703000046579078",
            },
          ],
          Added_Time: "11-16-2023 13:00:06",
        },
        {
          "Add_Estimate_Worksheet.Estimate_No": "EST-0302",
          ATTENTION: "",
          "Add_Estimate_Worksheet.Auto_No": "302",
          Description:
            "<div>Protection of Existing and New Conditions<br /></div>",
          Rate: "0.00",
          Apply_Tax_8_875: "false",
          Add_Estimate_Worksheet: {
            display_value: "1556703000046579063",
            ID: "1556703000046579063",
          },
          Final_Total: "",
          Sub_Total: "0.00",
          S_No: "400",
          Unit: "Unit",
          Name: "Protection of Existing/New Conditions",
          Qty: "1.00",
          Days: "0",
          Deliverable_Class: {
            display_value: "02 - Site Preparation",
            ID: "1556703000040039708",
          },
          ID: "1556703000046579094",
          Estimate_Tasks: [
            {
              display_value:
                "200;Wall Protection;Site;Plastic Protection Installation on Walls;0.00;0.00;1556703000046579126;1;0.00;02 - Site Preparation;0.00;0;0;0;0;0",
              ID: "1556703000046579126",
            },
            {
              display_value:
                "300;Floor Protection;Site;Ram Board Installation on Flooring;0.00;0.00;1556703000046579128;1;0.00;02 - Site Preparation;0.00;0;0;0;0;0",
              ID: "1556703000046579128",
            },
            {
              display_value:
                "400;Rubbish Removal;Site;Removal of debris/garbage/refuse;0.00;0.00;1556703000046579140;1;0.00;02 - Site Preparation;0.00;0;0;0;0;0",
              ID: "1556703000046579140",
            },
          ],
          Added_Time: "11-16-2023 13:09:56",
        },
        {
          "Add_Estimate_Worksheet.Estimate_No": "EST-0302",
          ATTENTION: "",
          "Add_Estimate_Worksheet.Auto_No": "302",
          Description:
            "<div>Demolition of Partition as per Approved Plan or Drawing<br /></div>",
          Rate: "0.00",
          Apply_Tax_8_875: "false",
          Add_Estimate_Worksheet: {
            display_value: "1556703000046579063",
            ID: "1556703000046579063",
          },
          Final_Total: "",
          Sub_Total: "0.00",
          S_No: "500",
          Unit: "Lumpsum",
          Name: "Demolition ",
          Qty: "1.00",
          Days: "4",
          Deliverable_Class: {
            display_value: "02 - Site Preparation",
            ID: "1556703000040039708",
          },
          ID: "1556703000046579098",
          Estimate_Tasks: [
            {
              display_value:
                "100;Architectural Demolition;Site;Removal/Demolition of Architectural Elements as per plan/drawing;0.00;0.00;1556703000046579112;3;0.00;02 - Site Preparation;0.00;0;0;0;0;0",
              ID: "1556703000046579112",
            },
            {
              display_value:
                "200;Electrical Demolition;Site;Removal/Demolition of Electrical Elements as per plan/drawing;0.00;0.00;1556703000046579114;1;0.00;02 - Site Preparation;0.00;0;0;0;0;0",
              ID: "1556703000046579114",
            },
          ],
          Added_Time: "11-16-2023 13:09:56",
        },
        {
          "Add_Estimate_Worksheet.Estimate_No": "EST-0302",
          ATTENTION: "",
          "Add_Estimate_Worksheet.Auto_No": "302",
          Description: "<div>Site Cleaning and Rubbish Removal<br /></div>",
          Rate: "16.00",
          Apply_Tax_8_875: "false",
          Add_Estimate_Worksheet: {
            display_value: "1556703000046579063",
            ID: "1556703000046579063",
          },
          Final_Total: "",
          Sub_Total: "16.00",
          S_No: "600",
          Unit: "Lumpsum",
          Name: "Site Cleaning",
          Qty: "1.00",
          Days: "3",
          Deliverable_Class: {
            display_value: "02 - Site Preparation",
            ID: "1556703000040039708",
          },
          ID: "1556703000046579102",
          Estimate_Tasks: [
            {
              display_value:
                "100;Cleaning;Site;Cleaning the adjacent areas on the wall due to demolition;0.00;16.00;1556703000046579120;1;16.00;02 - Site Preparation;0.00;0;0;0;0;1",
              ID: "1556703000046579120",
            },
          ],
          Added_Time: "11-16-2023 13:09:56",
        },
        {
          "Add_Estimate_Worksheet.Estimate_No": "EST-0302",
          ATTENTION: "",
          "Add_Estimate_Worksheet.Auto_No": "302",
          Description:
            "<div>Miscellaneous patching of walls after demo<br /></div>",
          Rate: "0.00",
          Apply_Tax_8_875: "false",
          Add_Estimate_Worksheet: {
            display_value: "1556703000046579063",
            ID: "1556703000046579063",
          },
          Final_Total: "",
          Sub_Total: "0.00",
          S_No: "900",
          Unit: "Square Foot",
          Name: "Rough Carpentry, Miscellaneous patching of walls after demo",
          Qty: "1.00",
          Days: "0",
          Deliverable_Class: {
            display_value: "06 - Woods and Plastics",
            ID: "1556703000040039712",
          },
          ID: "1556703000046579232",
          Estimate_Tasks: [],
          Added_Time: "11-16-2023 13:43:25",
        },
        {
          "Add_Estimate_Worksheet.Estimate_No": "EST-0302",
          ATTENTION: "",
          "Add_Estimate_Worksheet.Auto_No": "302",
          Description:
            "<div>Patch flooring at areas of wall removals to match existing<br /></div>",
          Rate: "0.00",
          Apply_Tax_8_875: "false",
          Add_Estimate_Worksheet: {
            display_value: "1556703000046579063",
            ID: "1556703000046579063",
          },
          Final_Total: "",
          Sub_Total: "0.00",
          S_No: "1000",
          Unit: "Square Foot",
          Name: "Rough Carpentry, Patch flooring",
          Qty: "1.00",
          Days: "0",
          Deliverable_Class: {
            display_value: "06 - Woods and Plastics",
            ID: "1556703000040039712",
          },
          ID: "1556703000046579236",
          Estimate_Tasks: [],
          Added_Time: "11-16-2023 13:43:25",
        },
        {
          "Add_Estimate_Worksheet.Estimate_No": "EST-0302",
          ATTENTION: "",
          "Add_Estimate_Worksheet.Auto_No": "302",
          Description: "<div>Walk-in Closet Fabrication<br /></div>",
          Rate: "0.00",
          Apply_Tax_8_875: "false",
          Add_Estimate_Worksheet: {
            display_value: "1556703000046579063",
            ID: "1556703000046579063",
          },
          Final_Total: "",
          Sub_Total: "0.00",
          S_No: "700",
          Unit: "Linear Foot",
          Name: "Closet Fabrication",
          Qty: "30.00",
          Days: "27",
          Deliverable_Class: {
            display_value: "Millwork/Cabinetry",
            ID: "1556703000046235045",
          },
          ID: "1556703000046579188",
          Estimate_Tasks: [
            {
              display_value:
                "100;Site Measurement;Site;Site Measurement for the Actual Dimensions;0.00;0.00;1556703000046579196;1;0.00;Millwork/Cabinetry;0.00;0;0;0;0;0",
              ID: "1556703000046579196",
            },
            {
              display_value:
                "200;Procurement of Materials;Procurement;Buying All Necessary Materials;0.00;0.00;1556703000046579198;1;0.00;Millwork/Cabinetry;0.00;0;0;0;0;0",
              ID: "1556703000046579198",
            },
            {
              display_value:
                "300;Fabrication;Millwork Shop;Fabrication of Closet (Drawers, shelves and Carcass);0.00;0.00;1556703000046579200;3;0.00;Millwork/Cabinetry;0.00;0;0;0;0;0",
              ID: "1556703000046579200",
            },
            {
              display_value:
                "400;Finishing;Millwork Shop;Painting or Installation of Finish;0.00;0.00;1556703000046579202;1;0.00;Millwork/Cabinetry;0.00;0;0;0;0;0",
              ID: "1556703000046579202",
            },
          ],
          Added_Time: "11-16-2023 13:33:30",
        },
        {
          "Add_Estimate_Worksheet.Estimate_No": "EST-0302",
          ATTENTION: "",
          "Add_Estimate_Worksheet.Auto_No": "302",
          Description: "<div>Walk-in Closet Fabrication<br /></div>",
          Rate: "0.00",
          Apply_Tax_8_875: "false",
          Add_Estimate_Worksheet: {
            display_value: "1556703000046579063",
            ID: "1556703000046579063",
          },
          Final_Total: "",
          Sub_Total: "0.00",
          S_No: "800",
          Unit: "Linear Foot",
          Name: "Closet Installation",
          Qty: "30.00",
          Days: "6",
          Deliverable_Class: {
            display_value: "Millwork/Cabinetry",
            ID: "1556703000046235045",
          },
          ID: "1556703000046579218",
          Estimate_Tasks: [
            {
              display_value:
                "100;Delivery;Logistics;Delivery of Fabricated Millwork to Site;0.00;0.00;1556703000046579226;1;0.00;Millwork/Cabinetry;0.00;0;0;0;0;0",
              ID: "1556703000046579226",
            },
            {
              display_value:
                "200;Installation;Site;Installation of Fabricated Millwork ;0.00;0.00;1556703000046579228;1;0.00;Millwork/Cabinetry;0.00;0;0;0;0;0",
              ID: "1556703000046579228",
            },
          ],
          Added_Time: "11-16-2023 13:41:39",
        },
      ];

      const tt = generateTasks(data, new Date("04/02/2019"));
      console.log(tt, "tasks-tt");
    </script>
  </body>
</html>
